<style>
    ul.ui-autocomplete {
        z-index: 99999;
    }
</style>
<!--手工开始-->
<div class="layer" id="Manualpage"
     style="position: fixed;left: 50%;top: 50%;margin-left: -275px;margin-top: -146.5px;display: none;z-index: 3;">
    <div class="title">
        添加微信公众账号
        <div class="close"><a href="#"><img src="/images/closebt.png" style="outline: none"></a></div>
    </div>

    <div class="layer_con3">
        <div class="tc">
            <!--<form id="form3" action="" method="post">-->
            <input type="hidden" name="ct-uinfo" class="ctuinfo">
            <input type="hidden" name="Type" value="38003">
            <div class="mt20">
                <p>文章URL <input type="radio" id="obj1" checked name='obj'> 微信号 <input type="radio" name='obj'
                                                                                      id="obj2"></p>
            </div>
            <!--<div class="verification">WOhUPw4g</div>-->
            <div>
                <input name="Url" type="text" id="obj1-1" placeholder="请输入公众号发布过的任意一篇文章的链接地址"
                       style="width:300px;text-align: center">
            </div>
            <!--<div class="verification">请输入从后台获取的文章链接</div>-->
            <div><input name="WxNumber" type="text" placeholder="请输入微信公众号账号"
                        style="width:300px;text-align: center;display: none" id="obj1-2">
                <p id="WeChattips" style="display: none">账号不存在，请确认 <span style="color: #FF0000">微信号是否正确</span>, <a
                        id="WeChattipsesy" href="javascript:;" style="color: #169BD5">确认继续添加</a></p>
            </div>
            <div class="keep">
                    <span style="margin-right:5px;"><input id="pickupinformation" type="submit" class="but_data"
                                                           style="width:160px;margin-left:10px" value='获取信息'></span>
            </div>
            <!--</form>-->
            <div class="manual">
                <span class="fl" id="fl3"><a href="#">一键授权</a></span>
                <span class="fr" id="fr3"><a href="#">验证码入住</a></span>
                <span class="fr" id="aptitude3" style="display:none;"><a href="#">资质认证入驻</a></span>
                <div class="clear"></div>
            </div>
        </div>
    </div>
</div>
<!--手工结束-->

<!--授权开始-->
<div class="layer" id="Authorizationpage"
     style="position: fixed;left: 50%;top: 50%;margin-left: -275px;margin-top: -178.5px; display: none;z-index: 3;">
    <div class="title">
        添加微信公众账号
        <div class="close"><a href="javascript:;" style="outline: none"><img src="/images/closebt.png"></a></div>
    </div>

    <div class="layer_con3">
        <div class="tc">
            <div><img src="/images/wechat.png"></div>
            <div class="mt20">
                <p>一键授权入驻需要您通过微信进行授权</p>
                <p>授权仅获取您的微信头像和名称，我们将会保护您的隐私！</p>
            </div>
            <div class="keep">
                <form id="form" action="" method='post'>
                    <input type="hidden" name="ct-uinfo" class="ctuinfo">
                    <input type="hidden" name="Type" value="38001">
                    <input type="submit" class="but_data" style="line-height: 21px;width:160px;margin-left:10px"
                           value="授权">
                </form>
            </div>
            <div class="manual" style="width: 180px;">
                <span class="fl" id="fl1"><a href="javascript:;">验证码入住</a></span>
                <span class="fr" id="fr1" style="display:none;"><a href="javascript:;">手动添加</a></span>
                <span class="fr" id="aptitude1" style="display:none;"><a href="#">资质认证入驻</a></span>
                <div class="clear"></div>
            </div>
        </div>
    </div>
</div>
<!--授权结束-->

<!--验证码开始-->
<div class="layer" id="Verificationcodepage"
     style="position: fixed;left: 50%;top: 50%;margin-left: -275px;margin-top: -176.5px; display: none;z-index: 3;">
    <div class="title">
        添加微信公众账号
        <div class="close"><a href="#" style="outline: none"><img src="/images/closebt.png"></a></div>
    </div>

    <div class="layer_con3">
        <div class="tc">
            <div class="mt20">
                <p>复制以下验证码到图文消息素材中</p>
            </div>
            <!--<form id="form1" action="" method="post">-->
            <input type="hidden" name="ct-uinfo" class="ctuinfo">
            <input id="identifyingcode-hide" name="YZM" type="hidden" style="width:300px;text-align: center;">
            <!--<div class="verification">WOhUPw4g</div>-->
            <div><input id="identifyingcode" type="text" style="width:300px;text-align: center;font-size: 15px">
            </div>
            <div class="mt10">
                <p>将带有验证码的文章链接地址填入下方</p>
            </div>
            <!--<div class="verification">请输入从后台获取的文章链接</div>-->
            <div><input name="Url" id="identifyingcode1" type="text" placeholder="请输入从后台获取的文章链接"
                        style="width:300px;text-align: center">
            </div>
            <div>Url地址必须以https://mp.weixin.qq.com/s?__biz=开头</div>
            <div class="keep">
                <input type="hidden" name="Type" value="38002">
                <span style="margin-right:5px;margin-left:60px"><input style="width:160px;margin-left:10px"
                                                                       class="but_data" type="submit"
                                                                       id="submit-add" value="添加"></span>

                <span><a href="Verificationcodetutorial.html" id="course" target=_blank><img
                        src="/images/icon62.png"> <span
                        style="color: #FF4F4F">教程</span></a></span>
            </div>
            <!--</form>-->
            <div class="manual" style="width: 180px;">
                <span class="fl" id="fl2"><a href="#">一键授权</a></span>
                <span class="fr" id="fr2" style="display:none;"><a href="#">手动添加</a></span>
                <span class="fr" id="aptitude2" style="display:none;"><a href="#">资质认证入驻</a></span>
                <div class="clear"></div>
            </div>
        </div>
    </div>
</div>
<!--验证码结束-->

<!-- 资质认证弹层开始 -->
<div class="layer" id="certification"
     style="position: fixed;left: 50%;top: 50%;margin-left: -275px;margin-top: -176.5px; display: none;z-index: 90000;">
    <div class="title">
        添加微信公众账号
        <div class="close"><a href="#" style="outline: none"><img src="/images/closebt.png"></a></div>
    </div>

    <div class="layer_con3">
        <div class="tc">
            <div class="mt20">
                <!--<p>公众号账号</p>-->
            </div>
            <!--<form id="form2" action="" method="post">-->
            <input type="hidden" name="ct-uinfo" class="ctuinfo">
            <!--<div class="verification">WOhUPw4g</div>-->
            <div>
                <input id="identifyAptitude" placeholder="请输入微信号" name="Aptitude" type="text"
                       style="width:300px;text-align: center;font-size: 14px">
            </div>
            <div id="Alreadyadded" style="display: none">
                <br>
                <span style="color: red">账号已存在，请勿重复添加</span>
            </div>
            <div id="abnormal" style="display: none;margin-top: 10px;">
                <span>该公众号可能存在异常，请确认<span style="color: red">微信号是否正确</span></span>
            </div>
            <div class="keep" id="confirm">
                <input type="hidden" name="Type" value="38004">
                <span>
                        <input id="Qualifications" style="width:160px;" class="but_data" type="submit" value="确认">
                    </span>
            </div>
            <div class="keep" style="display: none" id="confirm1">
                <input type="hidden" name="Type" value="38004">
                <span>
                        <input id="add" style="width:160px;" class="but_data" type="submit" value="确认">
                    </span>
                <span>
                        <input id="Qualifications1" style="width:160px;" class="but_add media_add_btn but_query" type="submit" value="取消">
                    </span>
            </div>
            <!--</form>-->
        </div>
    </div>
</div>
<!-- 资质认证弹层结束 -->

<script>

    $(function () {

        function getCookie(cookie_name) {
            var allcookies = document.cookie;
            var cookie_pos = allcookies.indexOf(cookie_name);   //索引的长度

            // 如果找到了索引，就代表cookie存在，
            // 反之，就说明不存在。
            if (cookie_pos != -1) {
                // 把cookie_pos放在值的开始，只要给值加1即可。
                cookie_pos += cookie_name.length + 1;      //这里容易出问题，所以请大家参考的时候自己好好研究一下
                var cookie_end = allcookies.indexOf(";", cookie_pos);

                if (cookie_end == -1) {
                    cookie_end = allcookies.length;
                }

                var value = unescape(allcookies.substring(cookie_pos, cookie_end));         //这里就可以得到你想要的cookie的值了。。。
            }
            return value;
        }

        // 调用函数
        var cookie_val = getCookie("ct-uinfo");

        /**
         * @desc   escape字符串,escape不编码字符有69个：*，-，.，@，_，0-9，a-z，A-Z
         * @param  字符串
         * @return 返回string等对象
         * @Add=Masj, Date: 2009-12-16
         */
        function escapeStr(str) {
            return escape(str).replace(/\+/g, '%2B').replace(/\"/g, '%22').replace(/\'/g, '%27').replace(/\//g, '%2F');
        };
        $('.ctuinfo').val(escapeStr(cookie_val));
        // 授权
        (function () {
            $('#form').attr("action", '/wx/WeChat.ashx?m=oauth');
        })();
        // 手工
        (function () {

            $('#obj1').off("click").on('click', function () {
                $('#obj1-1').show();
                $('#obj1-2').hide();
                $('#WeChattips').hide();
            })
            $('#obj2').off("click").on('click', function () {
                $('#obj1-1').hide();
                $('#obj1-2').show();
            })
            var a1 = '';
            var a2 = '';
            $('#pickupinformation').off('click').on('click', function () {
                $('#WeChattips').hide();
                if ($('#obj1').prop('checked') == true) {
                    if ($('#obj1-1').val().indexOf('https://mp.weixin.qq.com/s?__biz=') == -1) {
                        layer.msg('请输入正确的url地址', {time: 600});
                        return false;
                    }
                    a1 = escape($.trim($('#obj1-1').val()));
                    if (a1 == '') {
                        return false
                    }

                    $.getJSON('/api/WeixinOAuth/Add?Type=38003&Url=' + a1 + '&ct-uinfo=' + cookie_val, function (data) {
                        data=eval(data);
                        if (data.Status == 0) {
                            if (data.Result.WxID == 0) {
                                layer.msg('账号不存在，请确认url是否正确', {time: 600});
                                return false;
                            }
                            if (data.Result.WxID == -1) {
                                layer.msg('验证码错误，请确认', {time: 600});
                                return false;
                            }
                            ;
                            if (data.Result.WxID > 0) {
                                var a = true;
                                $.ajax({
                                    url: '/api/Media/CheckCanAdd?v=1_1',
                                    type: 'get',
                                    data: {WxID: data.Result.WxID},
                                    dataType: 'json',
                                    async: false,
                                    xhrFields: {
                                        withCredentials: true
                                    },
                                    crossDomain: true,
                                    success: function (data) {
                                        if (data.Result) {

                                            a = false;
                                        }
                                    }
                                });
                                if (a) {
                                    layer.msg('该账号已添加，请勿重复操作', {time: 600});
                                    return false;
                                }
                            }
                            ;

                            function WxNumber() {
                                if (data.Result.WxNumber != '') {
                                    return '&WxNumber=' + data.Result.WxNumber
                                } else {
                                    return ' '
                                }
                            }

                            window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                        }
                    })
                }

                if ($('#obj2').prop('checked') == true) {
                    a2 = $.trim($('#obj1-2').val());
                    if (a2 == '') {
                        return false
                    }

                    $.getJSON('/api/WeixinOAuth/Add?Type=38003&WxNumber=' + a2 + '&ct-uinfo=' + escapeStr(cookie_val), function (data) {
                        console.log(data);
                        data=eval(data);
                        if (data.Status == 0) {
                            if (data.Result.WxID == 0) {
                                $('#WeChattips').show();
                                $('#WeChattipsesy').off('click').on('click', function () {
                                    window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                                })
                                return false;
                            }
                            if (data.Result.WxID == -1) {
                                layer.msg('请确认系统生成的验证码是否与文章里的一致', {time: 600});
                                return false;
                            }
                            ;
                            if (data.Result.WxID > 0) {
                                var a = true;
                                $.ajax({
                                    url: '/api/Media/CheckCanAdd?v=1_1',
                                    type: 'get',
                                    data: {WxID: data.Result.WxID},
                                    dataType: 'json',
                                    async: false,
                                    xhrFields: {
                                        withCredentials: true
                                    },
                                    crossDomain: true,
                                    success: function (data) {
                                        if (data.Result) {
                                            a = false;
                                        }
                                    }
                                });
                                if (a) {
                                    layer.msg('该账号已添加，请勿重复操作', {time: 600});
                                    return false;
                                }
                            }
                            ;

                            function WxNumber() {
                                if (data.Result.WxNumber != '') {
                                    return '&WxNumber=' + data.Result.WxNumber
                                } else {
                                    return ' '
                                }
                            }

                            window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                        }
                        ;
                    })
                }
            })
        })();
        // 验证码
        (function () {
            $('#submit-add').off('click').on('click', function () {
                console.log(1);
                if ($('#identifyingcode1').val().indexOf('https://mp.weixin.qq.com/s?__biz=') == -1) {
                    layer.msg('请输入正确的url地址', {time: 600});
                    return false;
                }


                if ($('#identifyingcode1').val() == '' || $('#identifyingcode').val() == '') {
                    layer.msg('请填写url地址', {time: 600});
                    return false
                }
                $.getJSON('/api/WeixinOAuth/Add?Type=38002&Url=' + escape($.trim($('#identifyingcode1').val())) + '&ct-uinfo=' + escapeStr(cookie_val) + '&YZM=' + $.trim($('#identifyingcode-hide').val()), function (data) {
                    data=eval(data);
                    console.log(data);
                    if (data.Status == 0) {
                        if (data.Result.WxID == 0) {
                            layer.msg('账号不存在，请确认url是否正确', {time: 600});
                            return false;
                        }
                        if (data.Result.WxID == -1) {
                            layer.msg('验证码错误，请确认', {time: 600});
                            return false;
                        }
                        ;
                        if (data.Result.WxID > 0) {
                            var a = true;
                            $.ajax({
                                url: '/api/Media/CheckCanAdd?v=1_1',
                                type: 'get',
                                data: {WxID: data.Result.WxID},
                                dataType: 'json',
                                async: false,
                                xhrFields: {
                                    withCredentials: true
                                },
                                crossDomain: true,
                                success: function (data) {
                                    if (data.Result) {
                                        a = false;
                                    }
                                }
                            });
                            if (a) {
                                layer.msg('该账号已添加，请勿重复操作', {time: 600});
                                return false;
                            }
                        }
                        ;

                        function WxNumber() {
                            if (data.Result.WxNumber != '') {
                                return '&WxNumber=' + data.Result.WxNumber
                            } else {
                                return ' '
                            }
                        }

                        window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                    }
                })
            })

        })();

        //资质入驻
        (function () {
            /*微信号、微信名称模糊查询*/
            $('#identifyAptitude').off('keyup').on('keyup', function () {
                var val = $.trim($(this).val());

                if (val != '') {
                    $.ajax({
                        url: '/api/Media/GetBasicDict?v=1_1',
                        type: 'get',
                        data: {
                            Key: val
                        },
                        dataType: 'json',
                        async: false,
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function (data) {
                            if (data.Status == 0) {
                                var availableArr = [];
                                for (var i = 0; i < data.Result.length; i++) {
                                    if (data.Result[i].Name.toUpperCase().indexOf(val.toUpperCase()) != -1 || data.Result[i].Number.toUpperCase().indexOf(val.toUpperCase()) != -1) {
                                        availableArr.push(data.Result[i].Name+' '+data.Result[i].Number);
//                                        availableArr.push(data.Result[i].Number);
                                    }
                                }
                                /*将availableArr去重*/
                                var result = [];
                                for (var i = 0; i < availableArr.length; i++) {
                                    if (result.indexOf(availableArr[i]) == -1) {
                                        result.push(availableArr[i]);
                                    }
                                }

                                $('#identifyAptitude').autocomplete({
                                    source: availableArr
                                })
                            }
                        }
                    });
                }

                $('#abnormal').hide();
                $('#confirm').show();
                $('#confirm1').hide();
            });
            /*添加文本框聚焦事件，使其默认请求一次*/
            $('#identifyAptitude').off('focus').on('focus', function () {
                var val = $.trim($(this).val());
                if (val == '') {
                    $.ajax({
                        url: '/api/Media/GetBasicDict?v=1_1',
                        type: 'get',
                        data: {
                            Key: val
                        },
                        dataType: 'json',
                        async: false,
                        xhrFields: {
                            withCredentials: true
                        },
                        crossDomain: true,
                        success: function (data) {
                            if (data.Status == 0) {
                                var availableArr = [];
                                for (var i = 0; i < data.Result.length; i++) {
                                    if (data.Result[i].Name.toUpperCase().indexOf(val.toUpperCase()) != -1 || data.Result[i].Number.toUpperCase().indexOf(val.toUpperCase()) != -1) {
                                        availableArr.push(data.Result[i].Name+' '+data.Result[i].Number);
//                                        availableArr.push(data.Result[i].Number);
                                    }
                                }
                                /*将availableArr去重*/
                                var result = [];
                                for (var i = 0; i < availableArr.length; i++) {
                                    if (result.indexOf(availableArr[i]) == -1) {
                                        result.push(availableArr[i]);
                                    }
                                }

                                $('#identifyAptitude').autocomplete({
                                    source: availableArr
                                });
                            }
                        }
                    });
                }

            });

            $('#Qualifications').off('click').on('click', function () {
                $('#Alreadyadded').hide();
                $('#abnormal').hide();
                if ($('#identifyAptitude').val() == '') {
                    layer.msg('请输入公众号账号', {time: 600})
                    return false;
                }
                var identifyAptitude=''
                if(!$.trim($('#identifyAptitude').val().split(' ')[1])){
                    identifyAptitude=$('#identifyAptitude').val();
                }else {
                    identifyAptitude=$('#identifyAptitude').val().split(' ')[1]
                }
                console.log(identifyAptitude);
                $.getJSON('/api/WeixinOAuth/Add?Type=38004&WxNumber=' + identifyAptitude, function (data) {
                    data=eval(data);
//                    data=JSON.parse(data);
                    if (data.Status == 0) {
                        if (data.Result.WxID == 0) {
                            $('#abnormal').show();
                            $('#confirm').hide();
                            $('#confirm1').show();
                            $('#add').off('click').on('click', function () {
                                window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                            })
                            return false;
                        }
                        if (data.Result.WxID == -1) {
                            layer.msg('请确认系统生成的验证码是否与文章里的一致', {time: 600});
                            return false;
                        }
                        ;
                        if (data.Result.WxID > 0) {
                            var a = false;
                            $.ajax({
                                url: '/api/Media/CheckCanAdd?v=1_1',
                                type: 'get',
                                data: {WxID: data.Result.WxID},
                                dataType: 'json',
                                async: false,
                                xhrFields: {
                                    withCredentials: true
                                },
                                crossDomain: true,
                                success: function (data) {
                                    if (!data.Result) {
                                        $('#Alreadyadded').show();
                                        a = true;
                                    }
                                }
                            });
                            if (a) {
                                return false;
                            } else {
                                window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                            }
                        }
                        ;

                        function WxNumber() {
                            if (data.Result.WxNumber != '') {
                                return '&WxNumber=' + data.Result.WxNumber
                            } else {
                                return ' '
                            }
                        };

                    }
                })
            });

            $('#Qualifications1').off('click').on('click',function () {
                $('#abnormal').hide();
                $('#confirm').show();
                $('#confirm1').hide();
            })
        })();
    });

</script>