<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="description" content="描述文字，字数200内？">
<meta name="keywords" content="网站相关关键字，字数200内？">
<title>赤兔联盟平台</title>
    <link rel="stylesheet" type="text/css" href="/css/resetNew_editor.css"/>
    <link rel="stylesheet" type="text/css" href="/css/layoutNew_editor.css"/>
    <link rel="stylesheet" href="../css/jquery-ui.css">
    <script language="javascript" src="/api/check.ashx?NotCheckModule=true"
            type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.1.11.3.min.js"></script>
    <script type="text/javascript" src="../js/jquery.browser.js"></script>
    <script type="text/javascript" src="../js/Common_chitu.js"></script>
    <script type="text/javascript" src="../js/common.js"></script>
    <script type="text/javascript" src="../js/common_authority.js"></script>
    <script type="text/javascript" src="../js/layer/layer.js"></script>
    <script type="text/javascript" src="../js/jquery-ui.min.js"></script>
</head>

<body>
<!--顶部logo 导航-->
<!--#include file="../Base/header.html" -->


<!--中间内容-->
 <div class="order">
     <!--左侧菜单-->
     <!--#include file="../Base/Menu.html" -->

    <div class="order_r">
        <div class="list_box">
            <div class="list">
                <h2>添加微信公众号</h2>
            </div>

            <div class="gave">
                <div class="gave_l"><img src="/ImagesNew/pic26.jpg"></div>
                <div class="gave_r">
                    <div id="certification">
                        <div class="title">
                            <h2>资质入驻</h2>
                        </div>

                        <div class="layer_con3">
                            <div class="tc">
                                <div class="mt20">
                                    <!--<p>公众号账号</p>-->
                                </div>
                                <!--<form id="form2" action="" method="post">-->
                                <input type="hidden" name="ct-uinfo" class="ctuinfo">
                                <!--<div class="verification">WOhUPw4g</div>-->
                                <div>
                                    <input id="identifyAptitude" placeholder="请输入微信号" name="Aptitude" type="text"
                                           style="width:300px;text-align: center;font-size: 14px">
                                </div>
                                <div id="Alreadyadded" style="display: none">
                                    <br>
                                    <span style="color: red">账号已存在，请勿重复添加</span>
                                </div>
                                <div id="abnormal" style="display: none;margin-top: 10px;">
                                    <span>该公众号可能存在异常，请确认<span style="color: red">微信号是否正确</span></span>
                                </div>
                                <div class="keep" id="confirm">
                                    <input type="hidden" name="Type" value="38004">
                                    <span>
                        <input id="Qualifications" style="width:160px;" class="but_data" type="submit" value="确认">
                    </span>
                                </div>
                                <div class="keep" style="display: none" id="confirm1">
                                    <input type="hidden" name="Type" value="38004">
                                    <span>
                        <input id="add" style="width:160px;" class="but_data" type="submit" value="确认">
                    </span>
                                    <span>
                        <input id="Qualifications1" style="width:160px;" class="but_add media_add_btn but_query" type="submit" value="取消">
                    </span>
                                </div>
                                <!--</form>-->
                                <div class="manual" style="width: 180px;margin-top: 20px;">
                                    <span class="fl" id="fl2"><a href="#">一键授权</a></span>
                                    <span class="fr" id="fr2" style="display:none;"><a href="#">手动添加</a></span>
                                    <span class="fr" id="aptitude2" style="display:block;"><a href="#">验证码入驻</a></span>
                                    <div class="clear"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="line3"></div>

                </div>
                <div class="clear"></div>
            </div>

    </div>
</div>


</div>

     <!--底部-->
     <!--#include file="../Base/footer.html" -->


<script>
    function getCookie(cookie_name) {
        var allcookies = document.cookie;
        var cookie_pos = allcookies.indexOf(cookie_name);   //索引的长度

        // 如果找到了索引，就代表cookie存在，
        // 反之，就说明不存在。
        if (cookie_pos != -1) {
            // 把cookie_pos放在值的开始，只要给值加1即可。
            cookie_pos += cookie_name.length + 1;      //这里容易出问题，所以请大家参考的时候自己好好研究一下
            var cookie_end = allcookies.indexOf(";", cookie_pos);

            if (cookie_end == -1) {
                cookie_end = allcookies.length;
            }

            var value = unescape(allcookies.substring(cookie_pos, cookie_end));         //这里就可以得到你想要的cookie的值了。。。
        }
        return value;
    }

    // 调用函数
    var cookie_val = getCookie("ct-uinfo");

    /**
     * @desc   escape字符串,escape不编码字符有69个：*，-，.，@，_，0-9，a-z，A-Z
     * @param  字符串
     * @return 返回string等对象
     * @Add=Masj, Date: 2009-12-16
     */
    function escapeStr(str) {
        return escape(str).replace(/\+/g, '%2B').replace(/\"/g, '%22').replace(/\'/g, '%27').replace(/\//g, '%2F');
    };
    $('.ctuinfo').val(escapeStr(cookie_val));
    //资质入驻
    (function () {
        /*微信号、微信名称模糊查询*/
        $('#identifyAptitude').off('keyup').on('keyup', function () {
            var val = $.trim($(this).val());

            if (val != '') {
                $.ajax({
                    url: '/api/Media/GetBasicDict?v=1_1',
                    type: 'get',
                    data: {
                        Key: val
                    },
                    dataType: 'json',
                    async: false,
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (data) {
                        if (data.Status == 0) {
                            var availableArr = [];
                            for (var i = 0; i < data.Result.length; i++) {
                                if (data.Result[i].Name.toUpperCase().indexOf(val.toUpperCase()) != -1 || data.Result[i].Number.toUpperCase().indexOf(val.toUpperCase()) != -1) {
                                    availableArr.push(data.Result[i].Name+' '+data.Result[i].Number);
//                                        availableArr.push(data.Result[i].Number);
                                }
                            }
                            /*将availableArr去重*/
                            var result = [];
                            for (var i = 0; i < availableArr.length; i++) {
                                if (result.indexOf(availableArr[i]) == -1) {
                                    result.push(availableArr[i]);
                                }
                            }

                            $('#identifyAptitude').autocomplete({
                                source: availableArr
                            })
                        }
                    }
                });
            }

            $('#abnormal').hide();
            $('#confirm').show();
            $('#confirm1').hide();
        });
        /*添加文本框聚焦事件，使其默认请求一次*/
        $('#identifyAptitude').off('focus').on('focus', function () {
            var val = $.trim($(this).val());
            if (val == '') {
                $.ajax({
                    url: '/api/Media/GetBasicDict?v=1_1',
                    type: 'get',
                    data: {
                        Key: val
                    },
                    dataType: 'json',
                    async: false,
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (data) {
                        if (data.Status == 0) {
                            var availableArr = [];
                            for (var i = 0; i < data.Result.length; i++) {
                                if (data.Result[i].Name.toUpperCase().indexOf(val.toUpperCase()) != -1 || data.Result[i].Number.toUpperCase().indexOf(val.toUpperCase()) != -1) {
                                    availableArr.push(data.Result[i].Name+' '+data.Result[i].Number);
//                                        availableArr.push(data.Result[i].Number);
                                }
                            }
                            /*将availableArr去重*/
                            var result = [];
                            for (var i = 0; i < availableArr.length; i++) {
                                if (result.indexOf(availableArr[i]) == -1) {
                                    result.push(availableArr[i]);
                                }
                            }

                            $('#identifyAptitude').autocomplete({
                                source: availableArr
                            });
                        }
                    }
                });
            }

        });

        $('#Qualifications').off('click').on('click', function () {
            $('#Alreadyadded').hide();
            $('#abnormal').hide();
            if ($('#identifyAptitude').val() == '') {
                layer.msg('请输入公众号账号', {time: 600})
                return false;
            }
            var identifyAptitude=''
            if(!$.trim($('#identifyAptitude').val().split(' ')[1])){
                identifyAptitude=$('#identifyAptitude').val();
            }else {
                identifyAptitude=$('#identifyAptitude').val().split(' ')[1]
            }
            console.log(identifyAptitude);
            $.getJSON('/api/WeixinOAuth/Add?Type=38004&WxNumber=' + identifyAptitude, function (data) {
                data=eval(data);
//                    data=JSON.parse(data);
                if (data.Status == 0) {
                    if (data.Result.WxID == 0) {

                        var a = false;
                        $.ajax({
                            url: 'http://www.chitunion.com/api/media/VerifyWxNumber?v=1_1',
                            type: 'post',
                            data: {MediaName: $('#identifyAptitude').val()},
                            dataType: 'json',
                            async: false,
                            xhrFields: {
                                withCredentials: true
                            },
                            crossDomain: true,
                            success: function (data) {
                                if (data.Status) {
                                    $('#Alreadyadded').show();
                                    a = true;
                                }
                            }
                        });
                        if (a) {
                            return false;
                        } else {
                            window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                        }
//                        $('#abnormal').show();
//                        $('#confirm').hide();
//                        $('#confirm1').show();

//                        $('#add').off('click').on('click', function () {
//                            window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
//                        })
                        return false;
                    }
                    if (data.Result.WxID == -1) {
                        layer.msg('请确认系统生成的验证码是否与文章里的一致', {time: 600});
                        return false;
                    }
                    ;
                    if (data.Result.WxID > 0) {
                        var a = false;
                        $.ajax({
                            url: '/api/Media/CheckCanAdd?v=1_1',
                            type: 'get',
                            data: {WxID: data.Result.WxID},
                            dataType: 'json',
                            async: false,
                            xhrFields: {
                                withCredentials: true
                            },
                            crossDomain: true,
                            success: function (data) {
                                if (!data.Result) {
                                    $('#Alreadyadded').show();
                                    a = true;
                                }
                            }
                        });
                        if (a) {
                            return false;
                        } else {
                            window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                        }
                    }
                    ;

                    function WxNumber() {
                        if (data.Result.WxNumber != '') {
                            return '&WxNumber=' + data.Result.WxNumber
                        } else {
                            return ' '
                        }
                    };

                }
            })
        });

        $('#Qualifications1').off('click').on('click',function () {
            $('#abnormal').hide();
            $('#confirm').show();
            $('#confirm1').hide();
        })
    })();
    //    点击授权
    $('#fl2').off('click').on('click',function () {
        window.location="/MediaManager/accredit.html"
    });
    //    验证码
    $('#aptitude2').off('click').on('click',function () {
        window.location="/MediaManager/identifyingcode.html"
    })
</script>
</body>
</html>
