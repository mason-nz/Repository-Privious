<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="description" content="描述文字，字数200内？">
<meta name="keywords" content="网站相关关键字，字数200内？">
<title>赤兔联盟平台</title>
    <link rel="stylesheet" type="text/css" href="/css/resetNew_editor.css"/>
    <link rel="stylesheet" type="text/css" href="/css/layoutNew_editor.css"/>
    <script type="text/javascript" src="../js/jquery.1.11.3.min.js"></script>
    <script language="javascript" src="/api/check.ashx?NotCheckModule=true"
            type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.browser.js"></script>
    <script type="text/javascript" src="../js/Common_chitu.js"></script>
    <script type="text/javascript" src="../js/common.js"></script>
    <script type="text/javascript" src="../js/common_authority.js"></script>
    <script type="text/javascript" src="../js/layer/layer.js"></script>
</head>

<body>
<!--顶部logo 导航-->
<!--#include file="../Base/header.html" -->


<!--中间内容-->
 <div class="order">
     <!--左侧菜单-->
     <!--#include file="../Base/Menu.html" -->

    <div class="order_r">
        <div class="list_box">
            <div class="list">
                <h2>添加微信公众号</h2>
            </div>

            <div class="gave">
                <div class="gave_l"><img src="/ImagesNew/pic26.jpg"></div>
                <div class="gave_r">
                    <!--验证码开始-->
                    <div id="Verificationcodepage">
                        <div class="title">
                            <h2>验证码入驻</h2>
                        </div>

                        <div class="layer_con3">
                            <div class="tc">
                                <div class="mt20" style="margin-bottom: 15px;">
                                    <p>复制以下验证码到图文消息素材中</p>
                                </div>
                                <!--<form id="form1" action="" method="post">-->
                                <input type="hidden" name="ct-uinfo" class="ctuinfo">
                                <input id="identifyingcode-hide" name="YZM" type="hidden" style="width:300px;text-align: center;">
                                <!--<div class="verification">WOhUPw4g</div>-->
                                <div><input id="identifyingcode" type="text" style="width:300px;text-align: center;font-size: 15px;cursor: text;background-color:#f4f4f4;">
                                </div>
                                <div class="mt10" style="margin-bottom: 15px;margin-top: 15px;">
                                    <p>将带有验证码的文章链接地址填入下方</p>
                                </div>
                                <!--<div class="verification">请输入从后台获取的文章链接</div>-->
                                <div><input name="Url" id="identifyingcode1" type="text" placeholder="请输入从后台获取的文章链接"
                                            style="width:300px;text-align: center">
                                </div>
                                <div style="color: #a2a1a1;margin-top: 10px;font-size: 12px;">Url地址必须以https://mp.weixin.qq.com/s?__biz=开头</div>
                                <div class="keep">
                                    <input type="hidden" name="Type" value="38002">
                                    <span style="margin-right:5px;margin-left:60px"><input style="width:160px;margin-left:10px"
                                                                                           class="but_data" type="submit"
                                                                                           id="submit-add" value="添加"></span>

                                    <span><a href="Verificationcodetutorial.html" id="course" target=_blank><img
                                            src="/images/icon62.png"> <span
                                            style="color: #FF4F4F">教程</span></a></span>
                                </div>
                                <!--</form>-->
                                <div class="manual" style="width: 180px;margin-top: 20px;">
                                    <span class="fl" id="fl2"><a href="#">一键授权</a></span>
                                    <span class="fr" id="fr2" style="display:none;"><a href="#">手动添加</a></span>
                                    <span class="fr" id="aptitude2" style="display:block;"><a href="#">资质认证入驻</a></span>
                                    <div class="clear"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--验证码结束-->
                    <div class="line3"></div>

                </div>
                <div class="clear"></div>
            </div>

    </div>
</div>


</div>

     <!--底部-->
     <!--#include file="../Base/footer.html" -->


<script>
    function getCookie(cookie_name) {
        var allcookies = document.cookie;
        var cookie_pos = allcookies.indexOf(cookie_name);   //索引的长度

        // 如果找到了索引，就代表cookie存在，
        // 反之，就说明不存在。
        if (cookie_pos != -1) {
            // 把cookie_pos放在值的开始，只要给值加1即可。
            cookie_pos += cookie_name.length + 1;      //这里容易出问题，所以请大家参考的时候自己好好研究一下
            var cookie_end = allcookies.indexOf(";", cookie_pos);

            if (cookie_end == -1) {
                cookie_end = allcookies.length;
            }

            var value = unescape(allcookies.substring(cookie_pos, cookie_end));         //这里就可以得到你想要的cookie的值了。。。
        }
        return value;
    }

    // 调用函数
    var cookie_val = getCookie("ct-uinfo");

    /**
     * @desc   escape字符串,escape不编码字符有69个：*，-，.，@，_，0-9，a-z，A-Z
     * @param  字符串
     * @return 返回string等对象
     * @Add=Masj, Date: 2009-12-16
     */
    function escapeStr(str) {
        return escape(str).replace(/\+/g, '%2B').replace(/\"/g, '%22').replace(/\'/g, '%27').replace(/\//g, '%2F');
    };
    $('.ctuinfo').val(escapeStr(cookie_val));
    // 验证码
    (function () {
        // 显示验证码
        $('#Authorizationpage').hide();
        $('#Manualpage').hide();
        $('#Verificationcodepage').show();
        $('#identifyingcode').prop('disabled',true);
        /*随机生成4位验证码*/
        /*step1:将所有字母，数字装入一个数组备用*/
        var codes = [];
        //数字:48-57;unicode编码
        for (var i = 48; i < 57; codes.push(i), i++);
        /*console.log(codes);*/
        //大写字母:65-90;unicode编码
        for (var i = 65; i < 90; codes.push(i), i++);
        //小写字母:97-122;unicode编码
        for (var i = 97; i < 121; codes.push(i), i++);
        var arr = [];
        for (var i = 0; i < 8; i++) {   //从0-61之间取随机数
            var index = Math.floor(Math.random() * (30 - 0 + 1) + 0);
//                            console.log(index);
            var char = String.fromCharCode(codes[index]);
            arr.push(char);
        }
        /*console.log(arr);*/
        var code = arr.join("");
        $('#identifyingcode').val(code);
        $('#identifyingcode-hide').val(code);
        $('#submit-add').off('click').on('click', function () {
            console.log(1);
            if ($('#identifyingcode1').val().indexOf('https://mp.weixin.qq.com/s?__biz=') == -1) {
                layer.msg('请输入正确的url地址', {time: 600});
                return false;
            }


            if ($('#identifyingcode1').val() == '' || $('#identifyingcode').val() == '') {
                layer.msg('请填写url地址', {time: 600});
                return false
            }
            $.getJSON('/api/WeixinOAuth/Add?Type=38002&Url=' + escape($.trim($('#identifyingcode1').val())) + '&ct-uinfo=' + escapeStr(cookie_val) + '&YZM=' + $.trim($('#identifyingcode-hide').val()), function (data) {
                data=eval(data);
                console.log(data);
                if (data.Status == 0) {
                    if (data.Result.WxID == 0) {
                        layer.msg('账号不存在，请确认url是否正确', {time: 600});
                        return false;
                    }
                    if (data.Result.WxID == -1) {
                        layer.msg('验证码错误，请确认', {time: 600});
                        return false;
                    }
                    ;
                    if (data.Result.WxID > 0) {
                        var a = true;
                        $.ajax({
                            url: '/api/Media/CheckCanAdd?v=1_1',
                            type: 'get',
                            data: {WxID: data.Result.WxID},
                            dataType: 'json',
                            async: false,
                            xhrFields: {
                                withCredentials: true
                            },
                            crossDomain: true,
                            success: function (data) {
                                if (data.Result) {
                                    a = false;
                                }
                            }
                        });
                        if (a) {
                            layer.msg('该账号已添加，请勿重复操作', {time: 600});
                            return false;
                        }
                    }
                    ;

                    function WxNumber() {
                        if (data.Result.WxNumber != '') {
                            return '&WxNumber=' + data.Result.WxNumber
                        } else {
                            return ' '
                        }
                    }

                    window.location = '/mediamanager/addWeChatmedia.html?AuthType=' + data.Result.AuthType + '&WxID=' + data.Result.WxID + WxNumber();
                }
            })
        })

    })();
    //    点击授权
    $('#fl2').off('click').on('click',function () {
        window.location="/MediaManager/accredit.html"
    })
//    资质入驻
    $('#aptitude2').off('click').on('click',function () {
        window.location="/MediaManager/qualificationentry.html"
    })
    if(CTLogin.TypeID==1002){
        $('#aptitude2').hide();
    }
</script>
</body>
</html>
